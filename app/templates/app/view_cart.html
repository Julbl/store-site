{% extends "app/layout.html" %}
{% load static %}

{% block content %}

  <h1>Корзина</h1>
  
  <table class="cart-table">
    <thead>
      <tr>
        <th>Товар</th>
        <th>Цена</th>
        <th>Количество</th>
        <th>Сумма</th>
        <th>Действия</th>
      </tr>
    </thead>
    <tbody>
      {% for cart_item in cart_items %}
        <tr>
          <td class="cart-item">
            <img class="cart-item-image" src="{{ cart_item.product.image.url }}" alt="{{ cart_item.product.name }}">
            <div class="cart-item-details">
              <h3>{{ cart_item.product.name }}</h3>
              <p>{{ cart_item.product.description }}</p>
            </div>
          </td>
          <td>{{ cart_item.product.price }} руб.</td>
          <td class="quantity-column">
            <span class="quantity-display" id="quantity-display-{{ cart_item.id }}">{{ cart_item.quantity }}</span>
                <div class="quantity-buttons">
                    <button type="button" data-id="{{ cart_item.id }}" data-quantity="{{ cart_item.quantity }}" data-change="1" onclick="changeQuantity({{ cart_item.id }}, {{ cart_item.quantity }}, 1)">+</button>
                    <button type="button" data-id="{{ cart_item.id }}" data-quantity="{{ cart_item.quantity }}" data-change="-1" onclick="changeQuantity({{ cart_item.id }}, {{ cart_item.quantity }}, -1)">-</button>
                </div>
          </td>
          <td>{{ cart_item.subtotal }} руб.</td>
          <td>
            <a href="{% url 'remove_from_cart' cart_item.product.id %}">Удалить</a>
          </td>
        </tr>
      {% endfor %}
    </tbody>
    <tfoot>
      <tr>
        <td colspan="3"></td>
        <td>Итого: {{ total_price }} руб.</td>
        <td></td>
      </tr>
    </tfoot>
  </table>
  <script>
    function changeQuantity(cartItemId, currentQuantity, change) {
        fetch('/update_cart/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                'cart_item_id': cartItemId,
                'quantity': currentQuantity + change
            })
        })
        .then(response => {
            if (!response.ok) {
                throw new Error("HTTP error " + response.status);
            }
            return response.json();
        })
        .then(data => {
            // Обновление отображаемого количества и общей суммы
            const quantityDisplay = document.getElementById('quantity-display-' + cartItemId);
            if (quantityDisplay) {
                quantityDisplay.textContent = data.new_quantity;
                alert('Количество товара обновлено. Общая стоимость: ' + data.total_price + ' руб.');
            } else {
                console.error('Элемент quantity-display не найден для cart_item_id=' + cartItemId);
            }
        })
        .catch(error => {
            console.error(error);
            alert("Error: Не удалось увеличить количество.");
        });
    }
  </script>

  <style>
    .cart-table {
      width: 100%;
      border-collapse: collapse;
    }

    .cart-table th, .cart-table td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: center;
    }

    .cart-item {
      display: flex;
      align-items: center;
    }

    .cart-item-image {
      width: 2.5cm;
      height: 2.5cm;
      margin-right: 8px;
    }

    .cart-item-details {
      flex: 1;
      text-align: left;
    }

    .quantity-column {
      display: flex;
      align-items: center;
    }

    .quantity-display {
      margin: 0 10px;
    }

    .quantity-buttons {
      display: flex;
      flex-direction: column;
    }

    .quantity-button {
      background-color: #4caf50;
      color: #fff;
      border: none;
      padding: 5px 10px;
      margin: 2px;
      cursor: pointer;
    }
  </style>

{% endblock %}